!function(t){"use strict";function e(t){if("-"===t.value)return"-";switch(t.config.format){case"text":return t.value;case"number":return d3.format(",0f")(t.value);case"percent":return d3.format(".2%")(t.value);case"currency":return d3.format("$.2f")(t.value);default:return t.value}}function n(t){var e,n,r=d3.values(d3.rgb(t)).slice(0,3);for(e=0;e<r.length;++e)r[e]=r[e]/255,r[e]<=.03928?r[e]=r[e]/12.92:r[e]=Math.pow((r[e]+.055)/1.055,2.4);return n=.2126*r[0]+.7152*r[1]+.0722*r[2],n>.5?"black":"white"}function r(t,e){var n=t.indexOf(e);-1===n?t.push(e):t.splice(n,1)}function i(e){e=e||{},this.bindto="bindto"in e?e.bindto:"#d3c-table",this.selected="selected"in e?e.selected:[],this.description="description"in e?e.description:"#d3c-table-description",this.c3=t.c3,this.chart("chart"in e?e.chart:{data:{columns:[]}}),this.selectTable=d3.select(this.bindto).append("table"),this.selectTable.append("thead").append("tr"),this.selectTable.append("tbody"),this.data("data"in e?e.data:[]),this.columns("columns"in e?e.columns:[]),this.sort("sort"in e?e.sort:{})}function a(t,e){return function(n,r){var i=n.map(function(e,n){return e.key===t?n:void 0}).filter(isFinite),a=r.map(function(e,n){return e.key===t?n:void 0}).filter(isFinite);return"asc"===e?n[i].value>r[a].value:n[i].value<r[a].value}}function o(t){var r,i,a,o,c,s;t.each(function(t){var l=d3.select(this);"chart-bar"===t.config.type?(r=t.config.chart.x,i=t.config.chart.color,a=t.config.chart.width,l.select("svg").remove(),o=l.append("svg").attr({width:a,height:20}),o.append("rect").attr("class",function(t){return"bar bar--"+(t.value<0?"negative":"positive")}).attr("x",function(t){return r(t.config.chart.zeroBased?0:Math.min(0,t.value))}).attr("y",0).attr("rx",3).attr("ry",3).attr("width",function(t){return t.config.chart.zeroBased?Math.abs(r(t.value)):Math.abs(r(t.value)-r(0))}).attr("height",20).attr("fill",function(t){return t.color}),o.append("text").text(function(t){return e(t)}).attr("y",15).attr("x",function(t){var e=t.config.chart.zeroBased?Math.abs(r(t.value)):r(t.value);return t.config.chart.zeroBased?e>a/2?r(0)+Math.abs(r(0))+8:r(0)+Math.abs(r(t.value)-r(0))+5:e<r(0)?e<r(0)/2?e+5:e-40:e>r(0)+(a-r(0))/2?r(0)+Math.abs(r(t.value)-r(0))-40:r(0)+Math.abs(r(t.value)-r(0))}).attr("class",function(t){var e=r(t.value);return e<r(0)?e<r(0)/2?"d3c-chart-label-neg-high":"d3c-chart-label-neg-low":e>r(0)+(a-r(0))/2?"d3c-chart-label-pos-high":"d3c-chart-label-pos-low"}).style("fill",function(t){var e=r(t.value);return e<r(0)?e<r(0)/2?n(t.color):"#000":e>r(0)+(a-r(0))/2?n(t.color):"#000"})):"highlight"===t.config.type?(l.select("div").remove(),c=t.config.chart.color,l.append("div").style("background-color",function(t){return c(t.value)}).style("text-align","center").style("border-radius","3px").text(function(t){return e(t)}).style("color",function(){return n(d3.select(this).style("background-color"))})):"chart-spark"===t.config.type?(a=t.config.chart.width,l.select("svg").remove(),s=l.append("svg").attr({width:a,height:20}).append("path").attr("d",t.config.chart.line(t.config.chart.values)).attr("stroke","black").attr("stroke-width",.5).attr("fill","none")):l.text(function(t){return e(t)})})}var c={version:"0.0.1"};Array.prototype.indexOfObj=function(t){var e=this,n=0;for(n=0;n<e.length;n++)if(JSON.stringify(e[n])===JSON.stringify(t))return n;return-1},i.prototype.data=function(t){var e=this;return 0===arguments.length?this._data||[]:(this._data=this._data||[],t.forEach(function(t){e.addRow(t)}),void this.redraw())},i.prototype.unload=function(){this._data=[],this.selected=[],this.chart().hide(),this.chartUpdate(),this.chart().unload(),this.redraw()},i.prototype.addRow=function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push({key:e,value:t[e]});this._data.push(n),this.chartUpdate(),this.redraw()},i.prototype.updateRow=function(t){var e,n,r,i=this._data,a=[],o=function(t,r,i){for(e=0;e<t.length;e++)for(n=0;n<t[e].length;n++)if("key"in t[e][n]&&t[e][n].key===r&&"value"in t[e][n]&&t[e][n].value===i)return e;return null};if(e=o(i,"name",t.name),null==e)return void this.addRow(t);for(r in t)t.hasOwnProperty(r)&&a.push({key:r,value:t[r]});i[e]=a,this.chartUpdate(),this.redraw()},i.prototype.columns=function(t){return 0===arguments.length?this._columns||[]:(t||(t={}),this._columns=t,void this.redraw())},i.prototype.recalculate=function(){var t,e,n,r,i,a,o,c,s=this,l=this.columns(),h=this.data();s._tableWidth="undefined"==typeof s.selectTable.node()?100:s.selectTable.node().getBoundingClientRect().width,s._tableHeight="undefined"==typeof s.selectTable.node()?100:s.selectTable.node().getBoundingClientRect().height,l.length>0&&h.length>0&&(l.forEach(function(e,n){"chart-bar"!==e.type&&"highlight"!==e.type&&"chart-spark"!==e.type||(e.chart=e.chart||{},e.chart.values=[],t=parseFloat(e.width)/100,e.chart=e.chart||{},e.chart.zeroBased=e.chart.zeroBased||!1,e.chart.width=Math.floor(s._tableWidth*t),"chart-bar"===e.type||"highlight"===e.type?(h.forEach(function(t){t.forEach(function(t){t.key===e.key&&e.chart.values.push(+t.value)})}),e.chart.x=d3.scale.linear().range([0,e.chart.width]),e.chart.maxX=d3.max(e.chart.values,function(t){return+t}),e.chart.minX=d3.min(e.chart.values,function(t){return+t}),e.chart.maxX=e.chart.maxX>Math.abs(e.chart.minX)?e.chart.maxX:Math.abs(e.chart.minX),e.chart.minX=e.chart.minX<-1*e.chart.maxX?e.chart.minX:-1*e.chart.maxX,e.chart.colors=["#f05336","#faa224","#ffd73e","#c6e3bb","#a3d393","#64bc52"],e.chart.color=d3.scale.quantize().domain([e.chart.minX,0,e.chart.maxX]).range(e.chart.colors),e.chart.x.domain([e.chart.zeroBased?0:e.chart.minX,e.chart.maxX]).nice()):"chart-spark"===e.type&&(e.chart.values=[])),h.forEach(function(t){r=$.grep(t,function(t){return t.key===e.key}),($.isEmptyObject(r[0])||0===r.length)&&t.splice(n,0,{key:e.key,value:"-"})})}),h.forEach(function(t){t.forEach(function(r){n=$.grep(l,function(t){return t.key===r.key}),r.config=$.extend(!0,{},n[0])||{},r.config.match=!$.isEmptyObject(n[0]),"chart"in r.config&&("chart-bar"===r.config.type||"highlight"===r.config.type)?(r.x=r.config.chart.x(r.value)||0,r.color=r.config.chart.color(r.value)||"#000","colorFrom"in r.config.chart&&(e=$.grep(t,function(t){return t.key===r.config.chart.colorFrom}),r.color=e[0].color||r.color)):"chart"in r.config&&"chart-spark"===r.config.type&&(i=$.grep(t,function(t){return"series"===t.key}),a=$.grep(t,function(t){return"name"===t.key}),r.config.chart.values=i.length>0?i[0].value:[],o=a.length>0?a[0].value:"",c=r.config.chart.values.map(function(t){return t[o]}),r.config.chart.values=c,r.config.chart.x=d3.scale.linear().domain([0,c.length-1]).range([0,r.config.chart.width]),r.config.chart.y=d3.scale.linear().domain([d3.max(c),d3.min(c)]).range([0,20]),r.config.chart.line=d3.svg.line().x(function(t,e){return r.config.chart.x(e)}).y(function(t){return r.config.chart.y(t)}))})})),this.sort()},i.prototype.getRowName=function(t){var e;for(t=t||[],e=0;e<t.length;e++)if("name"===t[e].key)return t[e].value},i.prototype.getRowDescription=function(t){var e;for(t=t||[],e=0;e<t.length;e++)if("description"===t[e].key)return t[e].value},i.prototype.chart=function(t){return 0===arguments.length||$.isEmptyObject(t)?this._chart||{}:(t||(t={}),this.chartConfig(t),this._chart=this.c3.generate(this.chartConfig()),this._chart)},i.prototype.chartConfig=function(t){return 0===arguments.length||$.isEmptyObject(t)?this._chart_config||{}:(t||(t={}),this._chart_config=t,this._chart_config)},i.prototype.chartUpdate=function(){var t,e=this,n=this.chart(),r=this.data(),i=[],a=[],o=[];r.forEach(function(r){var c=e.getChartSeries(r);i=c.xs,o=c.values,a.push(o),t=e.getRowName(r),-1===e.selected.indexOf(t)&&(-1===n.internal.hiddenTargetIds.indexOf(t)&&(n.internal.hiddenTargetIds=n.internal.hiddenTargetIds.concat(t)),-1===n.internal.hiddenLegendIds.indexOf(t)&&(n.internal.hiddenLegendIds=n.internal.hiddenLegendIds.concat(t)))}),a.unshift(i),e._chart_config.columns=a,n.load({columns:e._chart_config.columns})},i.prototype.getChartSeries=function(t){var e,n,r=t.filter(function(t){return"name"===t.key}),i=1===r.length?r[0].value:"y",a=t.filter(function(t){return"series"===t.key}),o=1===a.length?a[0].value:[],c=o.map(function(t){return t[i]});return c.unshift(i),e=this.chartConfig().data.x||"x",n=o.map(function(t){return t[e]}),n.unshift(e),{xs:n,values:c}},i.prototype.rowSelect=function(t,e){var n=this,i=this.chart(n._chart_config),a=n.getRowName(t);t.forEach(function(t){"series"===t.key&&(n._chart_config=n._chart_config||{},n.selected=n.selected||[],r(n.selected,a),i.hide(null,{withLegend:!0}),i.show(n.selected,{withLegend:!0}))}),d3.select(e).classed("d3c-table-row-active",function(){return-1!==n.selected.indexOf(a)}),n.chartUpdate()},i.prototype.sort=function(t){var e=this.data();return e.length<2&&0===arguments.length?this._sort||{}:(0===arguments.length?(t=this._sort||{},"key"in t&&t.key.length&&"direction"in t&&(e.sort(a(t.key,t.direction)),this._data=e)):(this._sort={key:"key"in t?t.key:"",direction:"direction"in t?t.direction:"asc"},this.redraw()),this._sort)},i.prototype.sortColumn=function(t){var e=this,n=t.key||"",r="asc";"_sort"in e&&"key"in e._sort&&e._sort.key===n&&"direction"in e._sort&&(r="asc"===e._sort.direction?"desc":"asc"),this.sort({key:n,direction:r})},i.prototype.redrawHeader=function(){var t=this.columns(),e=this,n=this.selectTable.select("thead").selectAll("tr"),r=n.selectAll("th").data(t);r.enter().append("th").on("click",function(t){e.sortColumn(t),e.redraw()}).style("width",function(t){return t.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),r.html(function(t){var n="";return"_sort"in e&&"key"in e._sort&&e._sort.key===t.key&&"direction"in e._sort&&(n="asc"===e._sort.direction?"noticon noticon-uparrow":"noticon noticon-downarrow"),t.title+"<span class="+n+"></span>"}),r.exit().transition().delay(200).duration(500).style("opacity",0).remove();var i=n.selectAll("th").data(t);i.enter().append("th").style("width",function(t){return t.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),i.html(function(t){var n="";return"_sort"in e&&"key"in e._sort&&e._sort.key===t.key&&"direction"in e._sort&&(n="asc"===e._sort.direction?"noticon noticon-uparrow":"noticon noticon-downarrow"),t.title+"<span class="+n+"></span>"}),this.recalculate()},i.prototype.redrawRows=function(){var t,e,n=this,r=d3.select("body").append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").text("a simple tooltip"),i=this.data(),a=this.selectTable.select("tbody").on("mouseout",function(){d3.select(n.description).html("")}).selectAll("tr").data(i).on("click",function(t){n.rowSelect(t,this)}).on("mouseover",function(t){var e='<div class="d3c-table-descr"><strong>'+n.getRowName(t)+": </strong>"+n.getRowDescription(t)+"</div>";d3.select(n.description).html(e),r.style("visibility","visible").html(e)}).on("mousemove",function(){return r.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){return r.style("visibility","hidden")}).classed("d3c-table-row-active",function(t){return-1!==n.selected.indexOf(n.getRowName(t))});e=a.selectAll("td").data(function(t){return $.grep(t,function(t){return t.config.match})}),e.enter().append("td").style("width",function(t){return t.config.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),e.call(o),e.exit().transition().delay(200).duration(500).style("opacity",0).remove(),t=a.enter().append("tr").on("click",function(t){n.rowSelect(t,this)}).on("mouseover",function(t){var e='<div class="d3c-table-descr"><strong>'+n.getRowName(t)+": </strong>"+n.getRowDescription(t)+"</div>";d3.select(n.description).html(e),r.style("visibility","visible").html(e)}).on("mousemove",function(){return r.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){return r.style("visibility","hidden")}).classed("d3c-table-row-active",function(t){return-1!==n.selected.indexOf(n.getRowName(t))}).selectAll("td").data(function(t){return $.grep(t,function(t){return t.config.match})}),t.enter().append("td").style("width",function(t){return t.config.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),t.call(o),a.exit().transition().delay(200).duration(500).style("opacity",0).remove()},i.prototype.redraw=function(){this.recalculate(),this.redrawHeader(),this.redrawRows()},c.table=function(t){return new i(t)},"function"==typeof define&&define.amd?define("d3c",["d3"],function(){return c}):"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=c:t.d3c=c}(window);