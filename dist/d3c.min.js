!function(t){"use strict";function e(t){if("-"===t.value)return"-";switch(t.config.format){case"text":return t.value;case"number":return d3.format(",0f")(t.value);case"percent":return d3.format(".2%")(t.value);case"currency":return d3.format("$.2f")(t.value);default:return t.value}}function n(t){for(var e=d3.values(d3.rgb(t)).slice(0,3),n=0;n<e.length;++n)e[n]=e[n]/255,e[n]<=.03928?e[n]=e[n]/12.92:e[n]=Math.pow((e[n]+.055)/1.055,2.4);var r=.2126*e[0]+.7152*e[1]+.0722*e[2];return r>.5?"black":"white"}function r(t,e){var n=t.indexOf(e);-1===n?t.push(e):t.splice(n,1)}function a(e){e=e||{},this.bindto="bindto"in e?e.bindto:"#d3c-table",this.selected="selected"in e?e.selected:[],this.c3=t.c3,this.chart("chart"in e?e.chart:{data:{columns:[]}}),this.selectTable=d3.select(this.bindto).append("table"),this.selectTable.append("thead").append("tr"),this.selectTable.append("tbody"),this.data("data"in e?e.data:[]),this.columns("columns"in e?e.columns:[]),this.sort("sort"in e?e.sort:{}),this.allInstances=[],this.allInstances.push(this)}function i(t,e){return function(n,r){var a=n.map(function(e,n){return e.key==t?n:void 0}).filter(isFinite),i=r.map(function(e,n){return e.key==t?n:void 0}).filter(isFinite);return"asc"===e?n[a].value>r[i].value:n[a].value<r[i].value}}function c(t){t.each(function(t,r){var a=d3.select(this);if("chart-bar"===t.config.type){var i=t.config.chart.x,c=(t.config.chart.color,t.config.chart.width);a.select("svg").remove();var o=a.append("svg").attr({width:c,height:20});o.append("rect").attr("class",function(t){return"bar bar--"+(t.value<0?"negative":"positive")}).attr("x",function(t){return i(t.config.chart.zeroBased?0:Math.min(0,t.value))}).attr("y",0).attr("rx",3).attr("ry",3).attr("width",function(t){return t.config.chart.zeroBased?Math.abs(i(t.value)):Math.abs(i(t.value)-i(0))}).attr("height",20).attr("fill",function(t){return t.color}),o.append("text").text(function(t){return e(t)}).attr("y",15).attr("x",function(t){var e=t.config.chart.zeroBased?Math.abs(i(t.value)):i(t.value);return t.config.chart.zeroBased?e>c/2?i(0)+Math.abs(i(0))+8:i(0)+Math.abs(i(t.value)-i(0))+5:e<i(0)?e<i(0)/2?e+5:e-40:e>i(0)+(c-i(0))/2?i(0)+Math.abs(i(t.value)-i(0))-40:i(0)+Math.abs(i(t.value)-i(0))}).attr("class",function(t,e){var n=i(t.value);return n<i(0)?n<i(0)/2?"d3c-chart-label-neg-high":"d3c-chart-label-neg-low":n>i(0)+(c-i(0))/2?"d3c-chart-label-pos-high":"d3c-chart-label-pos-low"}).style("fill",function(t){var e=i(t.value);return e<i(0)?e<i(0)/2?n(t.color):"#000":e>i(0)+(c-i(0))/2?n(t.color):"#000"})}else if("highlight"===t.config.type){a.select("div").remove();var s=t.config.chart.color;a.append("div").style("background-color",function(t){return s(t.value)}).style("text-align","center").style("border-radius","3px").text(function(t){return e(t)}).style("color",function(t){return n(d3.select(this).style("background-color"))})}else if("chart-spark"===t.config.type){c=t.config.chart.width,a.select("svg").remove();a.append("svg").attr({width:c,height:20}).append("path").attr("d",t.config.chart.line(t.config.chart.values)).attr("stroke","black").attr("stroke-width",.5).attr("fill","none")}else a.text(function(t){return e(t)})})}var o={version:"0.0.1"};Array.prototype.indexOfObj=function(t){for(var e=this,n=0;n<e.length;n++)if(JSON.stringify(e[n])===JSON.stringify(t))return n;return-1},a.prototype.data=function(t){if(0===arguments.length)return this._data||[];this._data=this._data||[];var e=this;t.forEach(function(t){e.addRow(t)}),this.redraw()},a.prototype.addRow=function(t){var e=(this.chart(),[]);for(var n in t)t.hasOwnProperty(n)&&e.push({key:n,value:t[n]});this._data.push(e),this.chartUpdate(),this.redraw()},a.prototype.updateRow=function(t){var e=this._data,n=function(t,e,n){for(var r=0;r<t.length;r++)for(var a=0;a<t[r].length;a++)if("key"in t[r][a]&&t[r][a].key===e&&"value"in t[r][a]&&t[r][a].value===n)return r;return null},r=n(e,"name",t.name);if(null==r)return void this.addRow(t);var a=[];for(var i in t)t.hasOwnProperty(i)&&a.push({key:i,value:t[i]});e[r]=a,this.chartUpdate(),this.redraw()},a.prototype.columns=function(t){return 0===arguments.length?this._columns||[]:(t||(t={}),this._columns=t,void this.redraw())},a.prototype.recalculate=function(){var t=this.columns(),e=this.data(),n="undefined"==typeof this.selectTable.node()?100:this.selectTable.node().getBoundingClientRect().width;t.length>0&&e.length>0&&(t.forEach(function(t,r){if("chart-bar"===t.type||"highlight"===t.type||"chart-spark"===t.type){t.chart=t.chart||{},t.chart.values=[];var a=parseFloat(t.width)/100;t.chart=t.chart||{},t.chart.zeroBased=t.chart.zeroBased||!1,t.chart.width=Math.floor(n*a),"chart-bar"===t.type||"highlight"===t.type?(e.forEach(function(e){e.forEach(function(e){e.key===t.key&&t.chart.values.push(+e.value)})}),t.chart.x=d3.scale.linear().range([0,t.chart.width]),t.chart.maxX=d3.max(t.chart.values,function(t){return+t}),t.chart.minX=d3.min(t.chart.values,function(t){return+t}),t.chart.maxX=t.chart.maxX>Math.abs(t.chart.minX)?t.chart.maxX:Math.abs(t.chart.minX),t.chart.minX=t.chart.minX<-1*t.chart.maxX?t.chart.minX:-1*t.chart.maxX,t.chart.colors=["#f05336","#faa224","#ffd73e","#c6e3bb","#a3d393","#64bc52"],t.chart.color=d3.scale.quantize().domain([t.chart.minX,0,t.chart.maxX]).range(t.chart.colors),t.chart.x.domain([t.chart.zeroBased?0:t.chart.minX,t.chart.maxX]).nice()):"chart-spark"===t.type&&(t.chart.values=[])}e.forEach(function(e){var n=$.grep(e,function(e){return e.key===t.key});($.isEmptyObject(n[0])||0===n.length)&&e.splice(r,0,{key:t.key,value:"-"})})}),e.forEach(function(e,n){e.forEach(function(n,r){var a=$.grep(t,function(t){return t.key===n.key});if(n.config=$.extend(!0,{},a[0])||{},n.config.match=!$.isEmptyObject(a[0]),"chart"in n.config&&("chart-bar"===n.config.type||"highlight"===n.config.type)){if(n.x=n.config.chart.x(n.value)||0,n.color=n.config.chart.color(n.value)||"#000","colorFrom"in n.config.chart){var i=$.grep(e,function(t){return t.key===n.config.chart.colorFrom});n.color=i[0].color||n.color}}else if("chart"in n.config&&"chart-spark"===n.config.type){var c=$.grep(e,function(t){return"series"===t.key}),o=$.grep(e,function(t){return"name"===t.key});n.config.chart.values=c.length>0?c[0].value:[];var s=o.length>0?o[0].value:"",h=n.config.chart.values.map(function(t){return t[s]});n.config.chart.values=h,n.config.chart.x=d3.scale.linear().domain([0,h.length-1]).range([0,n.config.chart.width]),n.config.chart.y=d3.scale.linear().domain([d3.max(h),d3.min(h)]).range([0,20]),n.config.chart.line=d3.svg.line().x(function(t,e){return n.config.chart.x(e)}).y(function(t){return n.config.chart.y(t)})}})})),this.sort()},a.prototype.getRowName=function(t){t=t||[];for(var e=0;e<t.length;e++)if("name"===t[e].key)return t[e].value},a.prototype.chart=function(t){return 0===arguments.length||$.isEmptyObject(t)?this._chart||{}:(t||(t={}),this.chartConfig(t),this._chart=this.c3.generate(this.chartConfig()),this._chart)},a.prototype.chartConfig=function(t){return 0===arguments.length||$.isEmptyObject(t)?this._chart_config||{}:(t||(t={}),this._chart_config=t,this._chart_config)},a.prototype.chartUpdate=function(){var t=this,e=this.chart(),n=this.data(),r=[],a=[];n.forEach(function(n){var i=[];[r,i]=t.getChartSeries(n),a.push(i);var c=t.getRowName(n);-1===t.selected.indexOf(c)&&(-1===e.internal.hiddenTargetIds.indexOf(c)&&(e.internal.hiddenTargetIds=e.internal.hiddenTargetIds.concat(c)),-1===e.internal.hiddenLegendIds.indexOf(c)&&(e.internal.hiddenLegendIds=e.internal.hiddenLegendIds.concat(c)))}),a.unshift(r),t._chart_config.columns=a,e.load({columns:t._chart_config.columns})},a.prototype.getChartSeries=function(t){var e=t.filter(function(t){return"name"===t.key}),n=1===e.length?e[0].value:"y",r=t.filter(function(t){return"series"===t.key}),a=1===r.length?r[0].value:[],i=a.map(function(t){return t[n]});i.unshift(n);var c=this.chartConfig().data.x||"x",o=a.map(function(t){return t[c]});return o.unshift(c),[o,i]},a.prototype.rowSelect=function(t,e){var n=this,a=this.chart(n._chart_config),i=n.getRowName(t);t.forEach(function(t){"series"===t.key&&(n._chart_config=n._chart_config||{},n.selected=n.selected||[],r(n.selected,i),a.hide(null,{withLegend:!0}),a.show(n.selected,{withLegend:!0}))}),d3.select(e).classed("d3c-table-row-active",function(){return-1!==n.selected.indexOf(i)}),n.chartUpdate()},a.prototype.sort=function(t){var e=this.data();return e.length<2&&0===arguments.length?this._sort||{}:(0===arguments.length?(t=this._sort||{},"key"in t&&t.key.length&&"direction"in t&&(e.sort(i(t.key,t.direction)),this._data=e)):(this._sort={key:"key"in t?t.key:"",direction:"direction"in t?t.direction:"asc"},this.redraw()),this._sort)},a.prototype.sortColumn=function(t){var e=this,n=t.key||"",r="asc";"_sort"in e&&"key"in e._sort&&e._sort.key===n&&"direction"in e._sort&&(r="asc"===e._sort.direction?"desc":"asc"),this.sort({key:n,direction:r})},a.prototype.redrawHeader=function(){var t=this.columns(),e=this,n=this.selectTable.select("thead").selectAll("tr"),r=n.selectAll("th").data(t);r.enter().append("th").on("click",function(t){e.sortColumn(t),e.redraw()}).style("width",function(t){return t.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),r.html(function(t){var n="";return"_sort"in e&&"key"in e._sort&&e._sort.key===t.key&&"direction"in e._sort&&(n="asc"===e._sort.direction?"noticon noticon-uparrow":"noticon noticon-downarrow"),t.title+"<span class='"+n+"'></span>"}),r.exit().transition().delay(200).duration(500).style("opacity",0).remove();var a=n.selectAll("th").data(t);a.enter().append("th").style("width",function(t){return t.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),a.html(function(t){var n="";return"_sort"in e&&"key"in e._sort&&e._sort.key===t.key&&"direction"in e._sort&&(n="asc"===e._sort.direction?"noticon noticon-uparrow":"noticon noticon-downarrow"),t.title+"<span class='"+n+"'></span>"}),this.recalculate()},a.prototype.redrawRows=function(){var t=this,e=this.data();if(e.length>0){var n=this.selectTable.select("tbody").selectAll("tr").data(e).on("click",function(e){t.rowSelect(e,this)}).classed("d3c-table-row-active",function(e){return-1!==t.selected.indexOf(t.getRowName(e))}),r=n.selectAll("td").data(function(t){return $.grep(t,function(t){return t.config.match})});r.enter().append("td").style("width",function(t){return t.config.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),r.call(c),r.exit().transition().delay(200).duration(500).style("opacity",0).remove();var a=n.enter().append("tr").on("click",function(e){t.rowSelect(e,this)}).classed("d3c-table-row-active",function(e){return-1!==t.selected.indexOf(t.getRowName(e))}).selectAll("td").data(function(t){return $.grep(t,function(t){return t.config.match})});a.enter().append("td").style("width",function(t){return t.config.width}).style("opacity",0).transition().delay(500).duration(500).style("opacity",1),a.call(c),n.exit().transition().delay(200).duration(500).style("opacity",0).remove()}},a.prototype.redraw=function(){var t=this.columns(),e=this.data();t.length>0&&e.length>0&&(this.recalculate(),this.redrawHeader(),this.redrawRows())},o.table=function(t){return new a(t)},"function"==typeof define&&define.amd?define("d3c",["d3"],function(){return o}):"undefined"!=typeof exports&&"undefined"!=typeof module?module.exports=o:t.d3c=o}(window);